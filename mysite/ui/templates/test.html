{% extends 'base.html' %}
{% load static %}

{% block js %}
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<link href='{% static "css/test.css" %}'/>
<style src="{% static 'js/test.js' %}" type="text/javascript"></style>
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
{% endblock %}

{% block content %}

<button class="mic-toggle" id="mic">
  <span class="material-symbols-outlined">
    mic
    </span>
</button>

<audio class="playback" controls></audio>

<style>
  .material-symbols-outlined {
    font-variation-settings:
    'FILL' 0,
    'wght' 400,
    'GRAD' 0,
    'opsz' 24
  }


#mic {
  height: 5rem;
  width: 5rem;
}

.mic-toggle {
    position: relative;
    display:block;
    width: 8rem;
    height: 8rem;
    border-radius: 50%;
    background-color: crimson;
    margin-bottom: 4rem;
}

.mic-toggle:after,
.mic-toggle::before {
    --pad: 0rem;
    content: '';
    display: block;
    position: absolute;
    z-index: 0;
    background-color: rgba(220,20,60,0.2);
    top: var(--pad);
    left: var(--pad);
    right: var(--pad);
    bottom: var(--pad);
    border-radius: 50%;
}

.mic-toggle:after {
    transition: 0.4s;
}

.mic-toggle::before {
    transition: 0.2s;
}

.mic-toggle:hover:before {
    --pad: -1rem;
}

.mic-toggle:hover:after {
    --pad: -1rem
}

.mic-toggle:span {
    position: relative;
    z-index: 1;
    color: #fff;
    font-size: 6rem;
}

.mic-toggle.is-recording:after {
    animation: smoothPadAfter 0.6s ease-in alternate-reverse forwards infinite;
}

.mic-toggle.mic-toggle.is-recording:before {
  animation: smoothPadBefore 0.6s ease-in alternate-reverse forwards infinite;
}
@keyframes smoothPadAfter {
  0% {
    top: -2rem;
    left: -2rem;
    right: -2rem;
    bottom: -2rem;
  }
  100% {
    top: -1rem;
    left: -1rem;
    right: -1rem;
    bottom: -1rem;
  }
}

@keyframes smoothPadBefore {
  0% {
    top: -1rem;
    left: -1rem;
    right: -1rem;
    bottom:  -1rem;
  }
  100%{
    top: -0.5rem;
    left: -0.5rem;
    right: -0.5rem;
    bottom: -0.5rem;
  }
}

.playback {
  margin-bottom: 1rem;
  box-shadow: 0px 0px 1rem rgba(0,0,0,0.2);
  border-radius: 999px;
}

.is-hidden {
  display: none;
}
</style>

<script>
  const mic_btn = document.querySelector("#mic");
const playback = document.querySelector(".playback");

console.log("working");

mic_btn.addEventListener("click", ToggleMic);

let can_record = false;
let is_recording = false;

let recorder = null;

let chunks = [];

function SetupAudio() {
    console.log("Setup");
    if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
        navigator.mediaDevices.getUserMedia({
            audio: true
        })
        .then(SetupStream)
        .catch(err => {
            console.error(err)
        });
    }
}

SetupAudio();

function SetupStream(stream) {
    recorder = new MediaRecorder(stream);

    recorder.ondataavailable = e => {
        chunks.push(e.data);
    }

    recorder.onstop = e => {
        const blob = new Blob(chunks, {type: "audio/mpeg"});
        chunks = [];
        const audioUrl = window.URL.createObjectURL(blob);
        playback.src = audioUrl;
    }

    can_record = true;
}

function ToggleMic() {
    if (!can_record) return;

    is_recording = !is_recording;

    if (is_recording) {
        recorder.start();
        mic_btn.classList.add("is-recording")
    }
    else {
        recorder.stop();
        mic_btn.classList.remove("is-recording");
    }
}
</script>
{% endblock %}